<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>T.J. Telan</title>

  <!-- CSS -->
  <link rel="stylesheet" href="https://tjtelan.com/print.css" media="print">
  <link rel="stylesheet" href="https://tjtelan.com/tj.css">
  <!--<link rel="stylesheet" href="https:&#x2F;&#x2F;tjtelan.com&#x2F;newsletter.css">-->
  <link rel="stylesheet" href="https://tjtelan.com/hyde.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

  
  
  <link rel="alternate" type="application/atom+xml" title="Atom" href="https://tjtelan.com/atom.xml">
  
  
  
  <!-- Facebook open graph tags-->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://tjtelan.com/blog/deploy-postfix-gmail-relay-with-ansible/" />
   
  <meta property="og:title" content="Deploy Postfix Gmail relay with Ansible on Raspberry Pi" />
  
  
  <meta property="og:description" content="A walkthrough for configuring a Raspberry Pi Postfix relay from VCenter Server Appliance to gmail" />
  
  <!-- Twitter card tags -->
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:url" content="https://tjtelan.com/blog/deploy-postfix-gmail-relay-with-ansible/" />
   
  <meta name="twitter:title" content="Deploy Postfix Gmail relay with Ansible on Raspberry Pi" />
  
  
  <meta name="twitter:description" content="A walkthrough for configuring a Raspberry Pi Postfix relay from VCenter Server Appliance to gmail" />
  
  <meta name="twitter:creator" content="@ThatTJTelan" />
  <meta name="twitter:site" content="@ThatTJTelan" />

  
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-21509172-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];

  function gtag() {
    dataLayer.push(arguments);
  }
  gtag('js', new Date());
  gtag('config', 'UA-21509172-1');
</script>

</head>

<body class=" ">
  
  <div  id="sidebar" class="sidebar">
    <div class="container sidebar-sticky">
      <div class="sidebar-about">
        
        <a href="https://tjtelan.com">
          <h1>T.J. Telan</h1>
        </a>
        
        <p class="lede">Practical DevOps &amp; Developer Experience</p>
        
        
      </div>

      <ul class="sidebar-nav">
        
          
            
            <li class="sidebar-nav-item">
              <a href="/now/">Now</a>
            </li>
            
          
            
            <li class="sidebar-nav-item">
              <a href="/about/">About</a>
            </li>
            
          
            
            <li class="sidebar-nav-item">
              <a href="https://github.com/tjtelan">Github<img src="/nav-icons/github.svg" alt="Github"></a>
            </li>
            
          
            
            <li class="sidebar-nav-item">
              <a href="https://dev.to/tjtelan">Dev.to<img src="/nav-icons/dev-dot-to.svg" alt="Dev.to"></a>
            </li>
            
          
            
            <li class="sidebar-nav-item">
              <a href="https://stackoverflow.com/users/1672638/t-j-telan">Stack Overflow<img src="/nav-icons/stackoverflow.svg" alt="Stack Overflow"></a>
            </li>
            
          
            
            <li class="sidebar-nav-item">
              <a href="https://twitter.com/ThatTJTelan">Twitter<img src="/nav-icons/twitter.svg" alt="Twitter"></a>
            </li>
            
          
            
            <li class="sidebar-nav-item">
              <a href="https://www.twitch.tv/tjtelan">Twitch<img src="/nav-icons/twitch.svg" alt="Twitch"></a>
            </li>
            
          
            
            <li class="sidebar-nav-item">
              <a href="/atom.xml">RSS<img src="/nav-icons/rss.svg" alt="RSS"></a>
            </li>
            
          
        
      </ul>
    </div>
  </div>
  

  <div class="content container">
    
<div class="post">
    <h1 class="post-title">Deploy Postfix Gmail relay with Ansible on Raspberry Pi</h1>
    
    <span class="post-meta">
        4 min read
        &nbsp;&bull;&nbsp;
        2018-11-27
        
          &nbsp;&bull;
          
          &nbsp;
          <a  href="https://tjtelan.com/categories/how-to/">
              how-to
            </a>
          
          &nbsp;
          <a  href="https://tjtelan.com/categories/devops/">
              devops
            </a>
          
        
        
          &nbsp;&bull;
          
          &nbsp;
          <a  href="https://tjtelan.com/tags/ansible/">
              #ansible
            </a>
          
          &nbsp;
          <a  href="https://tjtelan.com/tags/postfix/">
              #postfix
            </a>
          
          &nbsp;
          <a  href="https://tjtelan.com/tags/raspberry-pi/">
              #raspberry pi
            </a>
          
          &nbsp;
          <a  href="https://tjtelan.com/tags/vmware/">
              #vmware
            </a>
          
        
      </span>

    <h2 id="why-would-we-want-to-do-this">Why would we want to do this?<a class="zola-anchor" href="#why-would-we-want-to-do-this" aria-label="Anchor link for: why-would-we-want-to-do-this">ðŸ”—</a></h2>
<p>The virtualization servers at work are running VMWare ESXi, with Vcenter Server Applicance (VCSA) as our bridge to using cool, free tools like Packer, and Terraform to automate my interactions with virtual resources.</p>
<p>A downside we discovered is VCSA's lack of support for SMTP that requires auth, which Google requires when you send mail through them.</p>
<p>Postfix can handle the anonymous request from VCSA, and send it out to gmail with provided creds.</p>
<h2 id="how-do-i-get-started">How do I get started?<a class="zola-anchor" href="#how-do-i-get-started" aria-label="Anchor link for: how-do-i-get-started">ðŸ”—</a></h2>
<p>Since we wanted to get an email whenever there as an issue with the virtualization servers, it made sense to hostthis service on its own hardware.</p>
<p>I am going to be hosting this service using a Raspberry Pi 3 model B running Raspbian Stretch, and configuring it from my host using Ansible. This detail is not critical for following this guide. Any Debian-derived OS (like Ubuntu) that Ansible supports will work for hosting.</p>
<p>You just need to make sure SSH is turned on, and that you have the IP address. (The default username/pass on RasPis is <code>pi</code>/<code>raspberry</code>)</p>
<p>At minimum, you need the following tools installed on your host:</p>
<ul>
<li>Python 3</li>
<li>Ansible 2.7</li>
</ul>
<p>Download this helpful role for installing Postfix. At the time of this writing, it was the best public Postfix Ansible role, because its documentation had examples of how to configure the deployment as a gmail relay. Very straight forward.</p>
<p><a href="https://github.com/Oefenweb/ansible-postfix">https://github.com/Oefenweb/ansible-postfix</a></p>
<p>If you install this role in your Ansible client's <code>role_path</code>,  then you can use the example playbook I slightly modified, (and annotated) from the ansible-postfix README.</p>
<h3 id="example-ansible-playbook">Example ansible playbook<a class="zola-anchor" href="#example-ansible-playbook" aria-label="Anchor link for: example-ansible-playbook">ðŸ”—</a></h3>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">---
</span><span style="color:#bf616a;">name</span><span style="color:#c0c5ce;">: </span><span style="color:#bf616a;">Setup basic raspberry pi host as SMTP relay (Rasbian)
hosts</span><span style="color:#c0c5ce;">:
    </span><span style="color:#bf616a;">mailproxy
vars</span><span style="color:#c0c5ce;">:
    </span><span style="color:#bf616a;">postfix_mynetworks</span><span style="color:#c0c5ce;">:
        </span><span style="color:#65737e;"># This is the IPv4 localhost loopback subnet
        </span><span style="color:#c0c5ce;">- &#39;</span><span style="color:#a3be8c;">127.0.0.0/8</span><span style="color:#c0c5ce;">&#39;             
        </span><span style="color:#65737e;"># This is the IPv4 mapped IPv6 localhost loopback subnet
        </span><span style="color:#c0c5ce;">- &#39;</span><span style="color:#a3be8c;">[::ffff:127.0.0.0]/104</span><span style="color:#c0c5ce;">&#39;  
        </span><span style="color:#65737e;"># This is the IPv6 localhost loopback address
        </span><span style="color:#c0c5ce;">- &#39;</span><span style="color:#a3be8c;">[::1]/128</span><span style="color:#c0c5ce;">&#39;               
        </span><span style="color:#65737e;"># This is the local private network subnet, like the IPv4 address space from your home router
        # This addition allows other hosts on the network to send mail through this relay!
        </span><span style="color:#c0c5ce;">- &#39;</span><span style="color:#a3be8c;">192.168.0.0/24</span><span style="color:#c0c5ce;">&#39;          
    </span><span style="color:#bf616a;">postfix_smtpd_relay_restrictions</span><span style="color:#c0c5ce;">:
        </span><span style="color:#65737e;">#  This says to permit requests if the client is in the $mynetworks whitelist
        #  http://www.postfix.org/postconf.5.html#permit_mynetworks
        </span><span style="color:#c0c5ce;">- </span><span style="color:#a3be8c;">permit_mynetworks
        </span><span style="color:#65737e;">#  This says relay the request if client is authenticated to the smtp server
        #  http://www.postfix.org/postconf.5.html#permit_sasl_authenticated
        </span><span style="color:#c0c5ce;">- </span><span style="color:#a3be8c;">permit_sasl_authenticated
        </span><span style="color:#65737e;">#  This says to reject the request unless it knows about the destination (the domain)
        #  http://www.postfix.org/postconf.5.html#reject_unauth_destination
        </span><span style="color:#c0c5ce;">- </span><span style="color:#a3be8c;">reject_unauth_destination

        </span><span style="color:#65737e;">## Lastly, I believe the order of these restrictions matter, so this last one must catch the rest of the garbage requests

    </span><span style="color:#bf616a;">postfix_relayhost</span><span style="color:#c0c5ce;">: </span><span style="color:#bf616a;">smtp.gmail.com
    postfix_smtp_tls_cafile</span><span style="color:#c0c5ce;">: </span><span style="color:#bf616a;">/etc/ssl/certs/ca-certificates.crt
    postfix_relaytls</span><span style="color:#c0c5ce;">: </span><span style="color:#d08770;">true
    </span><span style="color:#bf616a;">postfix_sasl_user</span><span style="color:#c0c5ce;">: &#39;</span><span style="color:#a3be8c;">username@gmail.com</span><span style="color:#c0c5ce;">&#39;
    </span><span style="color:#bf616a;">postfix_sasl_password</span><span style="color:#c0c5ce;">: &#39;</span><span style="color:#a3be8c;">apppasswordgeneratedgarbage</span><span style="color:#c0c5ce;">&#39;
</span><span style="color:#bf616a;">roles</span><span style="color:#c0c5ce;">:
    </span><span style="color:#a3be8c;">ansible-postfix
</span></code></pre><h4 id="some-additional-notes">Some additional notes<a class="zola-anchor" href="#some-additional-notes" aria-label="Anchor link for: some-additional-notes">ðŸ”—</a></h4>
<ul>
<li>To configure vCenter, I followed this guide. It might be helpful to note that I only found these instructions to work with the Flash-based client, not the HTML5-based client. But it would be really great if the settings could be configured over the command line with VMWare's vSphere CLI tool, <a href="https://github.com/vmware/govmomi/tree/master/govc">govc</a>
<ul>
<li><a href="https://docs.vmware.com/en/VMware-vSphere/6.5/com.vmware.vsphere.vcenterhost.doc/GUID-467DA288-7844-48F5-BB44-99DE6F6160A4.html">VMWare Docs - Configure Mail Sender Settings - VSphere 6.5</a></li>
</ul>
</li>
<li>Without the <code>postfix_mynetworks</code> addition of my local network, I was unable to successfully see email alerts from VCSA being sent from Postfix</li>
<li>This also differs from the Oefenweb/ansible-postfix example, in that I am not setting any <code>postfix_aliases</code>, since it was my experience that it didn't ever work. Email was always from whoever was configured as <code>postfix_sasl_user</code></li>
</ul>
<h3 id="test-the-configuration">Test the configuration<a class="zola-anchor" href="#test-the-configuration" aria-label="Anchor link for: test-the-configuration">ðŸ”—</a></h3>
<p>Here is how to send a test email, from the Raspberry Pi, using <code>mail</code></p>
<pre style="background-color:#2b303b;">
<code><span style="color:#bf616a;">pi@raspberrypi:~</span><span style="color:#c0c5ce;"> $ echo &quot;</span><span style="color:#a3be8c;">Hello world, it&#39;s ya boi, RaspberryPi</span><span style="color:#c0c5ce;">&quot; | </span><span style="color:#bf616a;">mail -s </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">[SMTP proxy] Hello World</span><span style="color:#c0c5ce;">&quot; your.email@domain.com
</span></code></pre>
</div>

<div class="blog-nav-footer">
    <hr/>
    
    <div class="previous-post">
        <p>Previous Post</p>
        <a href=https://tjtelan.com/blog/building-a-unix-shell-in-rust-part-4/>Building a Unix-shell in Rust - Part 4</a> <span>2018-01-21</span>
    </div>
    
    
    <div class="next-post">
        <p>Next Post</p>
        <a href=https://tjtelan.com/blog/using-a-database-grpc-with-rust/>Using a database + gRPC with Rust</a> <span>2019-04-25</span>
    </div>
    
</div>

  </div>

</body>

</html>